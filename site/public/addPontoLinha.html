<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>

  <link rel="stylesheet" href="css/header.css" />
  <link rel="stylesheet" href="css/criacaoVeiculo.css" />
  <link rel="stylesheet" href="css/menuDashboard.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://kit.fontawesome.com/89d28f01ec.js" crossorigin="anonymous"></script>
</head>

<body>
  <!--Começo do header-->

  <div class="navbar">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
      <path
        d="M224 0C348.8 0 448 35.2 448 80V96 416c0 17.7-14.3 32-32 32v32c0 17.7-14.3 32-32 32H352c-17.7 0-32-14.3-32-32V448H128v32c0 17.7-14.3 32-32 32H64c-17.7 0-32-14.3-32-32l0-32c-17.7 0-32-14.3-32-32V96 80C0 35.2 99.2 0 224 0zM64 128V256c0 17.7 14.3 32 32 32H352c17.7 0 32-14.3 32-32V128c0-17.7-14.3-32-32-32H96c-17.7 0-32 14.3-32 32zM80 400a32 32 0 1 0 0-64 32 32 0 1 0 0 64zm288 0a32 32 0 1 0 0-64 32 32 0 1 0 0 64z"
        fill="rgb(105,80,60)" />
    </svg>

    <h1>Adicionar Pontos a Linha</h1>
  </div>

  <div class="header">
    <div class="container">
      <ul>
        <li><a href=""> CONFIGURAÇÕES </a></li>
        <li><a href="menuDashboard.html"> VOLTAR </a></li>
      </ul>
    </div>
  </div>
  <!--Fim do header-->

  <!-- Conteúdo - Gráficos -->
  <main>
    <div class="conteudos">
      <div class="caixaContent">
        <div class="contentLinha">
          <div class="formRotas" style="display: flex;">
            <label for="iptCodRota">
              <p>Nome da rota:</p>
              <label for="" id="nomeLinhaSelect">AQUI VIRÁ O NOME DA ROTA</label>
              <p>Tipo de Linha:</p>
              <label for="" id="tipoLinhaSelect">AQUI VIRÁ O TIPO DA LINHA</label>
              <p>Ponto Inicial:</p>
              <label for="" id="pontoInicialSelect">AQUI VIRÁ O PONTO INICIAL</label>
              <p>Ponto Final:</p>
              <label for="" id="pontoFinalSelect">AQUI VIRÁ O PONTO FINAL</label>
            </label>
          </div>
          <div class="datalistPonto">
            <input list="browsers" name="browser" id="browser">
            <datalist id="browsers">
              <option value="Ponto01" id="testePontos"></option>
              <!-- <option value="Ponto02"></option>
                  <option value="Ponto03"></option>
                  <option value="Ponto04"></option>
                  <option value="Ponto05"></option> -->
            </datalist>
            <button onclick="addPonto()">Adicionar Ponto a Linha</button>
            <div id="pontosAdicionados"></div>
          </div>
        </div>
        <div class="btn-area">
          <button onclick="cadastrarPontoLinha()"><b>Adicionar+</b></button>

        </div>
      </div>

      <!-- Conteúdo - Veículos -->
      <aside>
        <div class="imgHeader">
          <img src="images/transpass.png" alt="" />
        </div>

        <div class="funcionarios">
          <p>Suas Rotas:</p>
          <ul>
            <li><a href="alterarVeiculo.html"> 775N-10 </a></li>
            <li><a href="alterarVeiculo.html"> 8707-10, 8707-31 </a></li>
            <li><a href="alterarVeiculo.html"> 715M-10, 748R-10 </a></li>
          </ul>

          <p><b>Clique na rota para gerenciá-la ou excluí-la</b></p>
        </div>
      </aside>
      <!-- Fim do Conteúdo - Veículos -->
    </div>
  </main>
  <!-- Fim do Conteúdo - Gráficos -->
</body>

</html>
<script>

  nomeLinhaSelect.innerHTML = sessionStorage.NOME_LINHA;
  tipoLinhaSelect.innerHTML = sessionStorage.TIPO_LINHA;
  pontoInicialSelect.innerHTML = sessionStorage.PONTO_INICIAL;
  pontoFinalSelect.innerHTML = sessionStorage.PONTO_FINAL;

  selectPonto();

  var vetorPonto = [];
  var vetorIdPontoSelect = [];


  function cadastrarPontoLinha() {

    for (var i = 0; i < vetorPonto.length; i++) {

      // Validações - Para fazer...

      fetch("/ponto/cadastrarPontoLinha", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({

          fkLinhaServer: sessionStorage.ID_LINHA,
          fkPontoServer: tipoLinhaVar
        })
      }).then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
          alert("Cadastro REALIZADO com Sucesso!!!")

          selectLinha();
          window.location.href = "addPontoLinha.html";

          sessionStorage.NOME_LINHA = nomeRotaVar;
          sessionStorage.TIPO_LINHA = tipoLinhaVar;
          sessionStorage.PONTO_INICIAL = pontoInicialVar;
          sessionStorage.PONTO_FINAL = pontoFinalVar;

        } else {
          throw ("Houve um ERRO ao tentar realizar o cadastro!");
        }
      }).catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });

      return false;
    }
  }

  function selectPonto() { //ATUALIZAR DATALIST DOS PONTOS

    fetch("/ponto/listar").then(function (resposta) {
      if (resposta.ok) {
        if (resposta.status == 204) {
          var feed = document.getElementById("browsers");
          var mensagem = document.createElement("option");
          mensagem.innerHTML = "Nenhum resultado encontrado." //SE NÂO APARECER NADA, MUDAR AQUI
          feed.appendChild(mensagem);
          throw "Nenhum resultado encontrado!!";
        }

        resposta.json().then(function (resposta) {
          console.log("Dados recebidos: ", JSON.stringify(resposta));

          var feed = document.getElementById("browsers");
          feed.innerHTML = "";
          for (let i = 0; i < resposta.length; i++) {
            var publicacao = resposta[i];

            var opcao = document.createElement("option");

            opcao.innerHTML = publicacao.logradouro;

            feed.appendChild(opcao);
          }
        });
      } else {
        throw ("Houve um erro na API")
      }
    }).catch(function (resposta) {
      console.error(resposta);
    });
  }

  function addPonto() {
    var iptPonto = browser.value;

    fetch("/ponto/listarId", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        logradouroServer: iptPonto
      })
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO listarId()!")

      if (resposta.ok) {
        console.log(resposta);

        resposta.json().then(json => {
          console.log(json);
          console.log(JSON.stringify(json));

          sessionStorage.ID_PONTO = json.idPonto;

          fetch("/linhaPonto/cadastrarLinhaPonto", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              idLinhaServer: sessionStorage.ID_LINHA,
              idPontoServer: sessionStorage.ID_PONTO
            }),
          })
            .then(function (resposta) {
              console.log("resposta: ", resposta);

              if (resposta.ok) {
                alert("Ponto adicionado com sucesso!!!");

                // setTimeout(() => {
                //   window.location = "menuDashboard.html";
                // }, "2000")
              } else {
                throw "Houve um ERRO ao tentar realizar o cadastro do ponto na linha!";
              }
            })
            .catch(function (resposta) {
              console.log(`#ERRO: ${resposta}`);
            });

          return false;
        });

      } else {

        console.log("Houve um erro ao listar o ID!");

        resposta.text().then(texto => {
          console.error(texto);
        });
      }

    }).catch(function (erro) {
      console.log(erro);
    })

    return false;


    vetorPonto.push(sessionStorage.ID_PONTO);

    pontosAdicionados.innerHTML = ``;

    for (var i = 0; i < vetorPonto.length; i++) {
      pontosAdicionados.innerHTML += `${i} - <span class='ponto' style="margin-right: 20px;">${vetorPonto[i]}</span>`
    }
  }

</script>